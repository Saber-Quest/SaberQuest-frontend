name: CI

on:
  push:
    branches:
      - dev/rewrite_reactnextjs
  pull_request:
    branches:
      - dev/rewrite_reactnextjs

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Copy over the files
              uses: appleboy/scp-action@master
              with:
                host: ${{ secrets.HOST }}
                username: ${{ secrets.USERNAME }}
                port: ${{ secrets.PORT }}
                password: ${{ secrets.PASSWORD }}
                rm: true
                source: "."
                target: "/var/www/saberquest.xyz"

            - name: Building the server
              uses: appleboy/ssh-action@master
              with:
                host: ${{ secrets.HOST }}
                username: ${{ secrets.USERNAME }}
                port: ${{ secrets.PORT }}
                password: ${{ secrets.PASSWORD }}
                script_stop: true
                script: |
                  cd "/var/www/"
                  rm "saberquest.xyz/.env.example"
                  touch "saberquest.xyz/.env"
                  cd "dev.saberquest.xyz"
                  cat ../secrets/.env.frontend > .env
                  pm2 delete saberquest -s
                  pm2 start npm --name "saberquest" -- run prod -s